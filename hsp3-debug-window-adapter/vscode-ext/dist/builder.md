# Builder

このファイルは `builder.hsp` の説明です。
(エンコーディングの問題を防ぐため、builder.hspには日本語を書かないようにしています。)

ビルダー (builder) は、HSP3のスクリプトをコンパイルするための最小限のツールです。
オブジェクトファイルの作成と実行ファイルの作成ができます。

## 使いかた

凡例:

```bat
    builder.exe <サブコマンド> --hsp <インストールディレクトリ> [OPTIONS...] <スクリプトファイル>
```

使用例:

```bat
    builder.exe compile --hsp "C:/hsp36" --out hello.ax hello.hsp
```

```bat
    builder.exe make --hsp "C:/hsp36" hello.hsp
```

コマンドライン引数の先頭にはサブコマンドを指定します。サブコマンドは以下のいずれかです:

- `compile`: スクリプトをコンパイルしてオブジェクトファイルを作る
- `make`: スクリプトをコンパイルして実行ファイルを作る
- `help`: ヘルプ表示
- `version`: バージョン表示

### `compile` サブコマンド

`compile` サブコマンドはオブジェクトファイルを生成します。

コンパイルに成功すると、指定したスクリプトと同じディレクトリに `start.ax` という名前でオブジェクトファイルが生成されます。
標準出力にコンパイラからのメッセージを書き込みます。
それに加えて、使用されるランタイムを以下のような構文で表示します。

```
#Use runtime "C:/hsp36/hsp3.exe"
```

コンパイルに失敗した場合は、エラーメッセージを標準出力に書き、コード1で終了します。

### `make` サブコマンド

`make` サブコマンドは実行ファイルを生成します。

処理に成功すると、指定したスクリプトと同じディレクトリに実行ファイルが生成されます。
ファイル名は、スクリプトファイルの名前の拡張子を `.exe` に変えたもの (例えば `hello.hsp` → `hello.exe`) です。
ただし、スクリプトが `#packopt name` でファイル名を指定している場合、その名前になります。

処理に失敗した場合は、エラーメッセージを標準出力に書き、コード1で終了します。

### `--hsp` オプション (必須)

```
    --hsp <インストールディレクトリ>
```

`--hsp` オプションに、HSP3のインストールディレクトリへの絶対パスを指定してください。

このオプションはサブコマンド `compile`, `make` の両方で必須です。

### `--no-utf8-input` フラグ (省略可)

`--no-utf8-input` フラグを指定すると、コンパイルされるスクリプトのエンコーディングをshift_jisだとみなします。

このフラグはすべてのサブコマンドで利用可能かつ省略可能です。省略時は、エンコーディングをutf-8だとみなします。

具体的には `hsc_comp` 命令の第2引数に影響します。既定ではフラグ32を指定しますが、`--no-utf8-input` フラグが指定されているときは、フラグ32を指定しません。
(なお、標準のスクリプトエディタはフラグ32を指定しません。)

### `--no-utf8-output` フラグ (省略可)

`--no-utf8-output` フラグを指定すると、コンパイルした結果であるオブジェクトファイルや実行ファイルに書き込まれるデータのエンコーディングが、shift_jisになります。

このフラグはすべてのサブコマンドで利用可能かつ省略可能です。省略時は、utf-8のエンコーディングでデータが書き込まれます。

具体的には `hsc_comp` 命令の第1引数に影響します。既定ではフラグ4を指定しますが、`--no-utf8-output` フラグが指定されているときは、フラグ4を指定しません。
(なお、標準のスクリプトエディタはフラグ4を指定しません。)

## ビルダーのビルド手順

ビルダー自身の実行ファイルを作る手順を説明します。

以下の作業は `hspcmp.dll` があるディレクトリ (例えばHSP3のインストールディレクトリ) で行う必要があります。

----

*ステップ1*: HSP3のインストールディレクトリに `hspcmp.exe` というツールがあり、スクリプトのオブジェクトファイルを作成できます。

例:

```bat
    C:\hsp36\hspcmp.exe --compath=C:\hsp36\common\ builder.hsp
```

HSP3のインストールディレクトリへの絶対パスを仮に `C:\hsp36` だとします。
引数に以下の2つを指定して、hspcmp.exeを実行します:

- `--compath=絶対パス\` という構文で、commonディレクトリへの絶対パスを指定します。(末尾のバックスラッシュは必須)
- `builder.hsp` へのパスを指定します

これによりビルダーのオブジェクトファイル (`builder.ax`) が生成されます。

----

*ステップ2*: 次に、ビルダー自身を使って、ビルダーの実行ファイルを作ります。

コマンドライン版のHSP3のランタイム `hsp3cl.exe` にビルダーのオブジェクトファイルを渡すことで、ビルダーを実行できます。
その引数としてビルダーのスクリプトを指定します。

```bat
    C:\hsp36\hsp3cl.exe builder.ax make --hsp C:\hsp36\ builder.ax
```

これによりビルダーの実行ファイル (`builder.exe`) が生成されます。

----
----

## その他

- `hspcmp.dll` の解説も参照してください

### ビルダーと `hspcmp.exe` の違い

- hspcmp.exe はコンパイルしたスクリプトを実行するためにどのランタイムを使えばよいのかを出力しません。使うランタイムが事前に分かっているスクリプトをコンパイルするときだけ使えます
- hspcmp.exe は実行ファイルを作成できません
