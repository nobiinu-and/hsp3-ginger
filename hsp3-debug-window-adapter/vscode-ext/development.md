# 開発者向けのドキュメント

## 背景

- (VSCodeの機能) VSCodeには「**デバッグ**」という、その名の通りプログラムをデバッグするための機能がある
    - 既定では、F5キーは「デバッグの開始」コマンドに割り当てられている
- (VSCodeの用語) VSCodeはタブに含まれるエディタ部分のことを **テキストエディタ** と呼んでいる
- (DAPの用語) VSCodeから起動されて、デバッグ実行するプログラムの管理を担当するプロセスを **デバッグアダプタ** (debug adapter) という

```
    VSCode ---> デバッグアダプタ ---> HSP
```

## 大まかな流れ

- この拡張機能をVSCodeにインストールする
- HSPのスクリプトを編集しているときに「デバッグを開始」(F5)を行う
- デバッグを開始すると、VSCodeがデバッグアダプタを起動する
- デバッグアダプタがスクリプトをコンパイル・実行する
- スクリプトの実行が終了したとき、またはデバッグUIで中止ボタンが押されたとき、デバッグが終了する

## 拡張機能の登録

`package.json` に拡張機能の情報がいろいろと書かれている

以下のプロパティが重要なはたらきをする:

- `activationEvents`: 拡張機能が有効になるタイミングを指定している
    - `onLanguage:hsp3`: 言語が「hsp3」であるテキストエディタを開いたとき
- `main`: 拡張機能のエントリーポイント (入口) を指定する
    - 拡張機能が有効になったとき、ここで指定したファイル (JavaScript) の `activate` という関数が実行される
- `contributes`: 拡張機能のコントリビューションポイント (拡張機能がどういう機能を提供するのかを明示するもの)
    - `languages`: 言語の種類を増やすことを表している
        - ここでは `.hsp` という拡張子が `hsp3` という名前の言語だと認識してほしい、という指定をしている
        - 他の拡張機能に同様の指定があるとき、同じ言語だと認識されている (はず)
    - `configuration`: 拡張機能ごとの設定項目を指定している。
        ここで指定した設定項目は、VSCodeの設定ファイル (`settings.json`) に書ける
    - `debuggers`: 拡張機能がデバッグ機能を提供することを指定している
        - `runtime`, `program`: デバッグを開始する際に、デバッグアダプタを起動する方法を指定している
            - `"runtime": "node"` はデバッグアダプタがNode.jsによって実行できることを指定している
            - `program`: そのエントリーポイントとなるJavaScriptのファイルを指定している

(筆者はあまり理解できていないので、公式のドキュメントを優先してほしい)

## 拡張機能の起動

- `extension.ts` の `activate` 関数が呼ばれる
- `DebugConfigurationProvider` というインターフェイスのインスタンスを登録しておく
    - 「設定の提供者」(configuration provider)を登録したらデバッグができるようになる、というのは言葉の上では直感的でないかもしれない。デバッグの開始の流れが「デバッグ実行用の設定を構築する」→「その設定に基づいてデバッグアダプタを起動する」という順なので、設定を作れるならデバッグできるということになる

## hsptmpの生成

編集しているスクリプトは必ずしもファイルに保存されていないので、何らかの方法でテキストエディタの内容をHSPのコンパイラに渡す必要がある。
デバッグ実行を開始する際に、その内容を `hsptmp` という名前のファイルに保存し、それへのファイルパスをデバッグアダプタ経由でコンパイラに渡すことで対処している。

ただしエンコーディングに注意する必要がある。
VSCodeでは、どのファイルを開いていても編集中のテキストは特定のエンコーディング (UTF-16) になっている。
もとのエンコーディングを知る方法も提供されていない (と思う)。
そのため `hsptmp` を書き込む際に、コンパイラが期待しているエンコーディングに変換している。

なお、デバッグ実行時に `hsptmp` を作る挙動は標準のスクリプトエディタも行っている。

## ビルダー

dist/builder.md を参照

---
---

予備知識 (まだ説明不足)

## おまけ: 文字コード

[HSP3 文字列のひみつ](https://www.onionsoft.net/hsp/v36/doclib/hsp3str.htm) を読んでほしい

- (おことわり) ここでは日本語圏でよく使われる文字だけを **文字** と呼ぶ。それ以外のものは無視する
- (符号化文字集合・文字コードとは) 文字に番号を振って、文字列を数列で表現できるとコンピュータで扱いやすい。
    文字と番号の対応づけのことを **符号化文字集合** (coded character set) という。
    文字に割り振られた数値を **文字コード** (character code) という
    - UTF-8とUTF-16は、どちらも同じ符号化文字集合を使うので、文字コードは同じ
- (エンコーディングとは) 文字列を文字コードからなる数列で表したとき、その数列をバイト列に対応付ける方法を「エンコーディングスキーム」(encoding scheme; 符号化方式)、略して **エンコーディング** という
    - UTF-8, UTF-16, shift_jis などのエンコーディングがある
- (ANSIとは) Windowsでは、UnicodeではないマルチバイトのエンコーディングのことをANSIと呼んでいるように思える
    - ANSIコードページというのがOS側で設定できて、それがどのエンコーディングを指すかは変更できる
    - 日本語版のWindowsでは、ANSIコードページはshift_jisと同じになっている
    - 参考:[コード ページ - Win32 apps | Microsoft Docs](https://docs.microsoft.com/ja-jp/windows/win32/intl/code-pages)

## おまけ: プロセス

- (プロセスとは) `*.exe` などの実行ファイルを実行することで生成される、「動作しているプログラム」のことを **プロセス** (process) という
- (子プロセスとは) プロセスが他の実行ファイルを起動することがある。そのとき生成されるプロセスを **子プロセス** (child process) という
- (パイプとは) **パイプ** というのがあって、これはデータの通信路のようなもの
    - 手短では説明しがたいので、詳しくは調べてほしい
    - プロセス間でデータを送受信するときによく使う
- (標準入出力とは) プロセスは起動した時点で、標準入力(stdin)、標準出力(stdout)、標準エラー(stderr)という3つのパイプが接続されている
    - 標準入力からはデータを読めて、標準出力と標準エラーにはデータを書ける
    - プロセス間でデータを送受信するときによく使う
    - コマンドライン版のHSP (`hsp3cl`) の `mes` 命令は標準出力に文字列を書く
- (終了コード) プロセスが終了する際に **終了コード** (exit code) という番号を1つ指定する
    - 正常に完了したかエラーが起こったのか、といった付加的な情報を伝えるのに使われる
    - 0は成功、0以外は失敗

## おまけ: Debug Adapter Protocol (DAP)

- (用語) デバッグ実行されているプロセスを **デバッギ** (debuggee)という

DAPについて:

- VSCodeとデバッギの間の仲介役として、**デバッグアダプタ** (debug adapter) というプログラムがある
    - VSCodeは特定の言語(HSP)をデバッグ実行する方法を知らない
    - デバッグアダプタはデバッグの開始時に起動される
    - VSCodeは「デバッギを起動せよ」といった指示をデバッグアダプタに送る
        - デバッグアダプタはVSCodeから来た指示を解釈して、デバッギを起動するための具体的な処理を行う
        - これにより、VSCodeが特定の言語の事情を知ることなく、デバッグUIが動く
    - 逆に、デバッグアダプタからVSCodeに指示を出すこともできる
        - 例えばデバッギが自発的に終了したとき、デバッグアダプタがVSCodeに「デバッギが終了した」ことを通知することで、VSCodeはデバッグの終了を認識できる
    - VSCode (などの開発ツール) とデバッグアダプタの間のやりとりを定めた仕様を Debug Adapter Protocol (**DAP**) という
        - デバッグアダプタに対してどのような指示を送れるか、あるいはどういう指示が送られてくるか、指示をどのように送受信するかということが決められている

DAPの実装は `@vscode/debugadapter` というライブラリを使っている

## HSP3のプログラムの実行

- HSPのスクリプトのコンパイルと実行は、次のように2段階になっている
- スクリプトからオブジェクトファイルを作る
    - オブジェクトファイルは `obj` または `*.ax` という名前のファイルに保存される
    - オブジェクトファイルの内容は、意味的にはもとのスクリプトと同じだが、実行しやすいように整理されている
- オブジェクトファイルをランタイムに渡す。ランタイムがその内容を実行する
    - ランタイムは `hsp3.exe` (通常版), `hsp3cl.exe` (コマンドライン版), runtimeディレクトリの下にある `hsp3utf.exe` (UTF-8版) など

## その他

- **Node.js**: JavaScriptの実行環境。JavaScriptのランタイムである **V8** に、ファイルの読み書きなどの機能を組み込んで提供しているもの
- **TypeScript**: JavaScriptに型システムを加えた言語。
    - コンパイルするとJavaScriptに変換される
    - 設定ファイル: `tsconfig.json`
- **Webpack**:
    - 複数のJavaScriptのファイルをまとめて1つのファイルにするツール
    - 設定ファイル: `webpack.config.js`
    - `ts-loader` というプラグインが内部的にTypeScriptのコンパイラを呼び出して、コンパイルを行うように設定している
- VSCodeの「タスク」機能を使って、スクリプトを実行することもできる。F5キーに割り当てられているほうが都合がいいので、それは使わなかった
- VSCodeのデバッグUIにある、中止ボタン以外の機能を使えるようにするには、デバッグアダプタとデバッギの間で追加の通信が必要になる
    - デバッグアダプタが必要な情報をデバッギから取り出したりデバッギに指示を送る方法が用意されているわけではないので難しい
    - デバッガ (hsp3debug) もカスタマイズすれば可能ではあるはず
